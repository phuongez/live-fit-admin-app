// ===== Generator & Datasource =====
generator client {
  provider = "prisma-client-js"
  // B·∫°n c√≥ th·ªÉ ƒë·ªïi/xo√° d√≤ng output n·∫øu mu·ªën d√πng m·∫∑c ƒë·ªãnh
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====
enum Role {
  JUNIOR // HLV th·ª≠ vi·ªác
  SENIOR // HLV chuy√™n b√°n
  SERVICE // HLV chuy√™n d·∫°y
  SUPERVISOR // HLV cao c·∫•p
  MANAGER // Qu·∫£n l√Ω (1 manager c√≥ th·ªÉ qu·∫£n nhi·ªÅu chi nh√°nh)
  ADMIN
}

enum CustomerType {
  ADULT
  CHILD
}

enum CustomerStage {
  LEAD
  DATA
  APPOINTMENT
  TRIAL
  WON
  LOST
}

enum CustomerSource {
  REFERRAL
  HOTLINE
  CARE // chƒÉm s√≥c l·∫°i
  COACH // HLV gi·ªõi thi·ªáu
  UID
  GOOGLE_ADS
  TIKTOK_ADS
  WEBSITE
}

enum ContractCategory {
  STANDARD // H·ª£p ƒë·ªìng th∆∞·ªùng
  GIFT // H·ª£p ƒë·ªìng t·∫∑ng k√®m
}

enum ContractAudience {
  ADULT
  CHILD
}

enum ContractModality {
  ONE_ON_ONE // 1:1
  ONE_ON_TWO // 1:2
}

enum ContractStatus {
  ACTIVE
  FROZEN
  EXHAUSTED
  CANCELLED
}

enum ScheduleStatus {
  BOOKED
  DONE
  NO_SHOW
  CANCELLED
}

enum ContractOrderType {
  MARKETING
  REFER
  RENEW
  MEMBER
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
  QR
}

// ===== T·ªï ch·ª©c =====
model Branch {
  id        String   @id @default(cuid())
  name      String
  address   String?
  createdAt DateTime @default(now())

  members   MemberBranch[]
  rooms     Room[]
  customers Customer[]

  contracts Contract[] // ƒë·ªëi ·ª©ng v·ªõi Contract.branch
  schedules Schedule[] // ƒë·ªëi ·ª©ng v·ªõi Schedule.branch
  sessions  Session[] // ƒë·ªëi ·ª©ng v·ªõi Session.branch
}

model MemberBranch {
  id           String @id @default(cuid())
  memberId     String
  branchId     String
  roleInBranch Role

  member Member @relation(fields: [memberId], references: [id])
  branch Branch @relation(fields: [branchId], references: [id])

  @@unique([memberId, branchId])
}

// ===== Nh√¢n s·ª± =====
model Member {
  id        String   @id @default(cuid())
  userId    String   @unique // Clerk user id
  fullName  String
  role      Role     @default(SERVICE)
  avatarUrl String?
  createdAt DateTime @default(now())

  // Th√¥ng tin c√° nh√¢n
  status           String? // Full time, Part time, ƒê√£ ngh·ªâ
  dateOfBirth      DateTime?
  nationalId       String? // S·ªë CCCD
  email            String?
  phone            String?
  currentAddress   String?
  permanentAddress String?
  bankAccount      String?
  bankName         String?
  bankHolder       String?
  startDate        DateTime?
  achievements     String? // Th√†nh t√≠ch (text)
  experience       String? // Kinh nghi·ªám (text)
  certificates     String? // B·∫±ng c·∫•p - ch·ª©ng ch·ªâ (text)

  // Quan h·ªá t·ªï ch·ª©c
  branches MemberBranch[]

  // CRM: HLV chƒÉm s√≥c + ng∆∞·ªùi t·∫°o kh√°ch
  customers        Customer[] @relation("CareCoach")
  createdCustomers Customer[] @relation("Creator")

  stageChanges     CustomerStageLog[] @relation("ChangedByMember")
  contractsCreated Contract[]         @relation("ContractsCreated")

  // H·ª£p ƒë·ªìng: ng∆∞·ªùi b√°n & ng∆∞·ªùi d·∫°y
  soldContracts    Contract[] @relation("Seller")
  serviceContracts Contract[] @relation("ServiceCoach")

  // L·ªãch/Bu·ªïi
  schedulesAsCoach Schedule[] @relation("CoachSchedules")
  sessionsAsCoach  Session[]  @relation("CoachSessions")

  // KPI & Payroll
  kpiAssignments KPIAssignment[] @relation("KPIAssignmentsForMember") // ƒë∆∞·ª£c giao
  kpiAssignedBy  KPIAssignment[] @relation("KPIAssignmentsCreatedBy") // m√¨nh giao cho ng∆∞·ªùi kh√°c
  kpiLogs        KPILog[]        @relation("KPILogsForMember")
  payrolls       Payroll[]       @relation("PayrollsForMember")

  uploadedPhotos ProgressPhoto[] @relation("MemberUploadedPhotos")

  approvedContracts Contract[] @relation("ApprovedContracts")

  requestedEdits CustomerEditRequest[] @relation("RequestedEdits")
approvedEdits  CustomerEditRequest[] @relation("ApprovedEdits")
}

// ===== Kh√°ch h√†ng (CRM) =====
model Customer {
  id          String       @id @default(cuid())
  code        String       @unique
  type        CustomerType
  fullName    String
  dateOfBirth DateTime?
  gender      String?
  avatarUrl   String?

  // Th√¥ng tin li√™n h·ªá & c√° nh√¢n
  nationalId     String? // S·ªë CCCD
  currentAddress String? // ƒê·ªãa ch·ªâ hi·ªán t·∫°i
  height         Float? // cm
  weight         Float? // kg

  // Th√¥ng tin gi√°m h·ªô (n·∫øu CHILD)
  guardianName  String?
  guardianPhone String?
  guardianZalo  String?

  // Li√™n h·ªá
  zaloPhone String?
  phones    CustomerPhone[]
  needs     String?
  source    CustomerSource?

  // H√¨nh ·∫£nh ti·∫øn b·ªô
  progressPhotos ProgressPhoto[]

  // Pipeline
  stage     CustomerStage      @default(LEAD)
  stageLogs CustomerStageLog[]

  // T·ªï ch·ª©c
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  // HLV chƒÉm s√≥c (m·∫∑c ƒë·ªãnh = ng∆∞·ªùi t·∫°o ho·∫∑c HLV c∆° s·ªü)
  careCoachId String?
  careCoach   Member? @relation("CareCoach", fields: [careCoachId], references: [id])

  createdById String?
  createdBy   Member? @relation("Creator", fields: [createdById], references: [id])

  // H·ª£p ƒë·ªìng / L·ªãch / ƒêi·ªÉm danh
  contractsAsPrimary   Contract[]            @relation("PrimaryCustomer")
  contractParticipants ContractParticipant[]
  schedules            Schedule[]            @relation("CustomerSchedules")
  attendances          SessionAttendance[]

  editRequests CustomerEditRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerPhone {
  id         String  @id @default(cuid())
  customerId String
  phone      String
  label      String?
  isPrimary  Boolean @default(false)

  customer Customer @relation(fields: [customerId], references: [id])

  @@unique([customerId, phone])
}

model CustomerStageLog {
  id          String         @id @default(cuid())
  customerId  String
  fromStage   CustomerStage?
  toStage     CustomerStage
  changedAt   DateTime       @default(now())
  changedById String?
  note        String?

  customer  Customer @relation(fields: [customerId], references: [id])
  changedBy Member?  @relation("ChangedByMember", fields: [changedById], references: [id])

  @@index([customerId, changedAt])
}

// ===== H·ª£p ƒë·ªìng =====
model Contract {
  id String @id @default(cuid())
  code            String   @unique
  category ContractCategory
  audience ContractAudience
  modality ContractModality

  // Kh√°ch ch√≠nh (ti·ªán truy v·∫•n 1:1)
  primaryCustomerId String?
  primaryCustomer   Customer? @relation("PrimaryCustomer", fields: [primaryCustomerId], references: [id])

  // Tham gia Hƒê (1:1 ho·∫∑c 1:2)
  participants ContractParticipant[]

  // Nh√¢n s·ª± li√™n quan
  sellerId String?
  seller   Member? @relation("Seller", fields: [sellerId], references: [id])

  serviceCoachId String?
  serviceCoach   Member? @relation("ServiceCoach", fields: [serviceCoachId], references: [id])

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  // T√†i ch√≠nh theo th·ªùi ƒëi·ªÉm k√Ω
  totalSessions   Int
  remaining       Int
  pricePerSession Decimal @db.Decimal(10, 2)

  startDate DateTime
  endDate   DateTime?
  status    ContractStatus @default(ACTIVE)

  sessions Session[]
  payments Payment[]

  createdById String?
  createdBy   Member?  @relation("ContractsCreated", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  schedules Schedule[] @relation("ContractSchedules")

    // üîπ Lo·∫°i ƒë∆°n: marketing, refer, renew, member
  orderType       ContractOrderType?             // enum m·ªõi (b√™n d∆∞·ªõi)

  // üîπ H√¨nh th·ª©c thanh to√°n ch√≠nh
  paymentMethod   PaymentMethod?                 // enum m·ªõi (b√™n d∆∞·ªõi)

    isApproved      Boolean   @default(false)
  approvedById    String?
  approvedBy      Member?   @relation("ApprovedContracts", fields: [approvedById], references: [id])
  note            String?

  @@index([branchId])
  @@index([sellerId])
  @@index([serviceCoachId])
}

model ContractParticipant {
  id         String @id @default(cuid())
  contractId String
  customerId String

  contract Contract @relation(fields: [contractId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@unique([contractId, customerId])
}

model Payment {
  id         String   @id @default(cuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])
  amount     Decimal  @db.Decimal(12, 2)
  method     PaymentMethod              // üîπ thay string b·∫±ng enum
  isDeposit  Boolean   @default(false)  // üîπ ti·ªÅn c·ªçc hay thanh to√°n ch√≠nh
  paidAt     DateTime  @default(now())

  @@index([contractId, paidAt])
}

// ===== L·ªãch & Bu·ªïi =====
model Room {
  id        String     @id @default(cuid())
  name      String
  branchId  String
  branch    Branch     @relation(fields: [branchId], references: [id])
  schedules Schedule[] @relation("RoomSchedules")
}

model Schedule {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  contractId String?
  contract   Contract? @relation("ContractSchedules", fields: [contractId], references: [id])

  coachId String
  coach   Member @relation("CoachSchedules", fields: [coachId], references: [id])

  roomId String?
  room   Room?   @relation("RoomSchedules", fields: [roomId], references: [id])

  startsAt DateTime
  endsAt   DateTime
  status   ScheduleStatus @default(BOOKED)

  sessionId String?  @unique
  session   Session? @relation("ScheduleToSession", fields: [sessionId], references: [id])

  customerId String
  customer   Customer @relation("CustomerSchedules", fields: [customerId], references: [id])

  createdAt DateTime @default(now())

  @@index([branchId, startsAt])
  @@index([coachId, startsAt])
}

model Session {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  scheduleId String?
  schedule   Schedule? @relation("ScheduleToSession")

  coachId String
  coach   Member @relation("CoachSessions", fields: [coachId], references: [id])

  startedAt   DateTime
  endedAt     DateTime?
  consumed    Boolean   @default(false)
  consumeNote String?

  attendances SessionAttendance[]

  @@index([branchId, startedAt])
}

model SessionAttendance {
  id         String  @id @default(cuid())
  sessionId  String
  customerId String
  present    Boolean @default(true)
  note       String?

  session  Session  @relation(fields: [sessionId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  @@unique([sessionId, customerId])
}

// ===== KPI & Payroll =====
model KPIAssignment {
  id       String @id @default(cuid())
  memberId String
  month    Int
  year     Int

  // Target (giao ch·ªâ ti√™u)
  salesTarget        Decimal? @db.Decimal(12, 2)
  sessionsTarget     Int?
  renewRateTarget    Decimal? @db.Decimal(5, 2) // %
  newContractsTarget Int?

  // Ng∆∞·ªùi giao KPI (th∆∞·ªùng l√† Manager)
  assignedById String?
  assignedBy   Member? @relation("KPIAssignmentsCreatedBy", fields: [assignedById], references: [id])

  // Ng∆∞·ªùi ƒë∆∞·ª£c giao KPI
  member Member @relation("KPIAssignmentsForMember", fields: [memberId], references: [id])

  createdAt DateTime @default(now())

  @@unique([memberId, month, year])
}

model KPILog {
  id             String   @id @default(cuid())
  memberId       String
  month          Int
  year           Int
  revenue        Decimal  @default(0) @db.Decimal(12, 2)
  sessionsTaught Int      @default(0)
  renewRate      Decimal? @db.Decimal(5, 2)
  newContracts   Int      @default(0)

  member Member @relation("KPILogsForMember", fields: [memberId], references: [id])

  @@unique([memberId, month, year])
}

model Payroll {
  id           String   @id @default(cuid())
  memberId     String
  month        Int
  year         Int
  base         Decimal  @default(0) @db.Decimal(12, 2)
  perSession   Decimal  @default(0) @db.Decimal(12, 2)
  commission   Decimal  @default(0) @db.Decimal(12, 2)
  bonus        Decimal  @default(0) @db.Decimal(12, 2)
  penalty      Decimal  @default(0) @db.Decimal(12, 2)
  total        Decimal  @default(0) @db.Decimal(12, 2)
  calculatedAt DateTime @default(now())

  member Member @relation("PayrollsForMember", fields: [memberId], references: [id])

  @@unique([memberId, month, year])
}

model ProgressPhoto {
  id           String   @id @default(cuid())
  customerId   String
  url          String
  takenAt      DateTime @default(now())
  uploadedById String?

  customer   Customer @relation(fields: [customerId], references: [id])
  uploadedBy Member?  @relation("MemberUploadedPhotos", fields: [uploadedById], references: [id])
}

model CustomerEditRequest {
  id           String   @id @default(cuid())
  customerId   String
  field        String               // Tr∆∞·ªùng ƒë∆∞·ª£c s·ª≠a, v√≠ d·ª•: "phone", "address"
  oldValue     String?
  newValue     String?
  note         String?              // Ghi ch√∫ t·ª´ ng∆∞·ªùi ƒë·ªÅ xu·∫•t
  status       EditStatus @default(PENDING)
  requestedById String
  requestedBy   Member  @relation("RequestedEdits", fields: [requestedById], references: [id])
  approvedById  String?
  approvedBy    Member? @relation("ApprovedEdits", fields: [approvedById], references: [id])
  reviewedAt    DateTime?
  createdAt     DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])
}

enum EditStatus {
  PENDING
  APPROVED
  REJECTED
}